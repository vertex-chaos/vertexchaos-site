---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { site as DefaultSite } from "../../config/site";
import Tag from "../../components/Tag.astro";
import { getCollection } from "astro:content";

const site = DefaultSite;

// Pull everything in the "work" collection, then apply sane defaults:
// - show unless draft/hidden/published=false
// - this avoids "only 1 shows" because of missing fields
const entries = (await getCollection("work"))
  .filter((e) => {
    const d = e.data ?? {};
    const draft = d.draft ?? false;
    const hidden = d.hidden ?? false;
    const published = d.published ?? true;
    return !draft && !hidden && published;
  })
  .sort((a, b) => {
    const ad = a.data ?? {};
    const bd = b.data ?? {};
    const at = new Date(ad.date ?? 0).getTime();
    const bt = new Date(bd.date ?? 0).getTime();
    return bt - at;
  });
---

<BaseLayout title={`Work | ${site.brand}`} description="Generalized case studies with the parts clients care about: problem, approach, result.">
  <div class="mb-10">
    <h1 class="text-3xl font-semibold tracking-tight text-slate-900">Work</h1>
    <p class="mt-3 max-w-2xl text-slate-600">
      Generalized case studies with the parts clients care about: problem, approach, result.
    </p>
  </div>

  <div class="grid gap-6">
    {entries.map((entry) => {
      const d = entry.data ?? {};
      const title = d.title ?? entry.slug;
      const summary = d.summary ?? "";
      const client = d.client ?? "Client";
      const tags = Array.isArray(d.tags) ? d.tags : [];

      return (
        <a
          href={`/work/${entry.slug}/`}
          class="group block rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition hover:border-slate-300 hover:shadow"
        >
          <div class="text-xs uppercase tracking-wide text-slate-500">{client}</div>
          <h2 class="mt-2 text-xl font-semibold text-slate-900 group-hover:underline">{title}</h2>
          {summary && <p class="mt-2 text-slate-600">{summary}</p>}

          {tags.length > 0 && (
            <div class="mt-4 flex flex-wrap gap-2">
              {tags.map((t) => <Tag label={t} />)}
            </div>
          )}
        </a>
      );
    })}
  </div>
</BaseLayout>